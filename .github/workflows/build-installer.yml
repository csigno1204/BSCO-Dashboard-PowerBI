name: üèóÔ∏è Build Windows Installer

on:
  push:
    tags:
      - 'v*'  # D√©clench√© sur les tags v1.0.0, v1.1.0, etc.
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  build-windows-installer:
    name: Build .exe Installer
    runs-on: windows-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: üîê Generate self-signed certificate
        run: |
          Write-Host "üîê G√©n√©ration du certificat auto-sign√©..." -ForegroundColor Cyan

          # Cr√©er le dossier certificates
          New-Item -ItemType Directory -Path "scripts\certificates" -Force | Out-Null

          # Param√®tres du certificat
          $certSubject = "CN=BSCO Solutions, O=BSCO Solutions, L=Geneva, S=Geneva, C=CH"
          $certPassword = ConvertTo-SecureString -String "BexioDashboard2024" -Force -AsPlainText
          $validYears = 3
          $notAfter = (Get-Date).AddYears($validYears)

          # G√©n√©rer le certificat
          $cert = New-SelfSignedCertificate `
              -Type CodeSigningCert `
              -Subject $certSubject `
              -KeyAlgorithm RSA `
              -KeyLength 2048 `
              -HashAlgorithm SHA256 `
              -NotAfter $notAfter `
              -CertStoreLocation "Cert:\CurrentUser\My" `
              -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}false")

          # Exporter en .pfx (avec mot de passe)
          $pfxPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $certPassword | Out-Null

          # Exporter en .cer (cl√© publique)
          $cerPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.cer"
          Export-Certificate -Cert $cert -FilePath $cerPath | Out-Null

          # Installer le certificat dans le magasin Root (pour ce build)
          $store = New-Object System.Security.Cryptography.X509Certificates.X509Store("Root", "CurrentUser")
          $store.Open("ReadWrite")
          $store.Add($cert)
          $store.Close()

          Write-Host "‚úÖ Certificat g√©n√©r√© et install√©" -ForegroundColor Green
          Write-Host "   Subject: $certSubject"
          Write-Host "   Valid until: $notAfter"
          Write-Host "   Thumbprint: $($cert.Thumbprint)"

      - name: üî® Build executable with PyInstaller (1st pass - without certificate)
        run: |
          Write-Host "üî® Compilation de l'exe (1√®re passe)..." -ForegroundColor Cyan
          pyinstaller --clean installer/BexioDashboard.spec

      - name: ‚úçÔ∏è Sign executable
        run: |
          Write-Host "‚úçÔ∏è Signature de l'exe..." -ForegroundColor Cyan

          # Trouver SignTool.exe
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $signtool) {
            Write-Error "‚ùå SignTool.exe not found. Installing Windows SDK..."
            choco install windows-sdk-10-version-2004-all -y
            $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          }

          $signtoolPath = $signtool.FullName
          Write-Host "‚úÖ SignTool found: $signtoolPath"

          # Signer l'exe
          $exePath = "dist\BexioDashboard\BexioDashboard.exe"
          $pfxPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.pfx"
          $password = "BexioDashboard2024"

          & $signtoolPath sign /f $pfxPath /p $password /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /v $exePath

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Exe sign√© avec succ√®s" -ForegroundColor Green
          } else {
            Write-Error "‚ùå √âchec de la signature"
            exit 1
          }

      - name: üìú Extract certificate from signed exe
        run: |
          Write-Host "üìú Extraction du certificat de l'exe sign√©..." -ForegroundColor Cyan

          $exePath = "dist\BexioDashboard\BexioDashboard.exe"
          $signature = Get-AuthenticodeSignature -FilePath $exePath

          if ($signature.Status -eq "Valid") {
            # Exporter le certificat
            $cerPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.cer"
            $certBytes = $signature.SignerCertificate.Export([System.Security.Cryptography.X509Certificates.X509ContentType]::Cert)
            [System.IO.File]::WriteAllBytes($cerPath, $certBytes)
            Write-Host "‚úÖ Certificat extrait: $cerPath" -ForegroundColor Green
          } else {
            Write-Error "‚ùå La signature n'est pas valide"
            exit 1
          }

      - name: üî® Rebuild executable with certificate included (2nd pass)
        run: |
          Write-Host "üî® Recompilation de l'exe AVEC certificat inclus (2√®me passe)..." -ForegroundColor Cyan
          pyinstaller --clean installer/BexioDashboard.spec

      - name: ‚úçÔ∏è Re-sign final executable
        run: |
          Write-Host "‚úçÔ∏è Re-signature de l'exe final..." -ForegroundColor Cyan

          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $signtoolPath = $signtool.FullName

          $exePath = "dist\BexioDashboard\BexioDashboard.exe"
          $pfxPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.pfx"
          $password = "BexioDashboard2024"

          & $signtoolPath sign /f $pfxPath /p $password /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /v $exePath

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Exe final sign√© avec succ√®s" -ForegroundColor Green
          } else {
            Write-Error "‚ùå √âchec de la signature finale"
            exit 1
          }

      - name: üìÇ List dist directory
        run: |
          dir dist\BexioDashboard
          echo "Executable created successfully!"

      - name: üß™ Test executable
        run: |
          # Test que l'exe existe
          if (Test-Path "dist\BexioDashboard\BexioDashboard.exe") {
            Write-Host "‚úÖ BexioDashboard.exe created successfully"
            $size = (Get-Item "dist\BexioDashboard\BexioDashboard.exe").Length / 1MB
            Write-Host "üìä Size: $([math]::Round($size, 2)) MB"

            # V√©rifier la signature
            $signature = Get-AuthenticodeSignature -FilePath "dist\BexioDashboard\BexioDashboard.exe"
            Write-Host "üîê Signature Status: $($signature.Status)"
            Write-Host "üìã Signer: $($signature.SignerCertificate.Subject)"
          } else {
            Write-Error "‚ùå BexioDashboard.exe not found"
            exit 1
          }

      - name: üì• Install Inno Setup via Chocolatey
        run: |
          # Installer Inno Setup avec Chocolatey (pr√©-install√© sur GitHub Actions)
          choco install innosetup -y

          # V√©rifier l'installation
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "‚úÖ Inno Setup installed successfully"
          } else {
            Write-Error "‚ùå Inno Setup installation failed"
            exit 1
          }

      - name: üèóÔ∏è Build installer with Inno Setup
        run: |
          Write-Host "üèóÔ∏è Compilation de l'installeur..." -ForegroundColor Cyan

          # Chemin d'installation par d√©faut d'Inno Setup
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"

          if (Test-Path $iscc) {
            & $iscc "installer\BexioDashboard_Setup.iss"
          } else {
            Write-Error "‚ùå Inno Setup Compiler not found at $iscc"
            exit 1
          }

      - name: ‚úçÔ∏è Sign installer
        run: |
          Write-Host "‚úçÔ∏è Signature de l'installeur..." -ForegroundColor Cyan

          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $signtoolPath = $signtool.FullName

          $installer = Get-Item "dist\installer\BexioDashboard_Setup_*.exe"
          $pfxPath = "scripts\certificates\BSCO_CodeSigning_SelfSigned.pfx"
          $password = "BexioDashboard2024"

          & $signtoolPath sign /f $pfxPath /p $password /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /v $installer.FullName

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Installeur sign√© avec succ√®s" -ForegroundColor Green
          } else {
            Write-Error "‚ùå √âchec de la signature de l'installeur"
            exit 1
          }

      - name: üì¶ Verify installer created
        run: |
          if (Test-Path "dist\installer\BexioDashboard_Setup_*.exe") {
            $installer = Get-Item "dist\installer\BexioDashboard_Setup_*.exe"
            Write-Host "‚úÖ Installer created: $($installer.Name)"
            $size = $installer.Length / 1MB
            Write-Host "üìä Size: $([math]::Round($size, 2)) MB"

            # V√©rifier la signature de l'installeur
            $signature = Get-AuthenticodeSignature -FilePath $installer.FullName
            Write-Host "üîê Installer Signature Status: $($signature.Status)"
            Write-Host "üìã Installer Signer: $($signature.SignerCertificate.Subject)"
          } else {
            Write-Error "‚ùå Installer not found"
            exit 1
          }

      - name: üìÑ Create distribution README
        run: |
          Write-Host "üìÑ Cr√©ation du README de distribution..." -ForegroundColor Cyan

          # Copier le README dans le dossier portable
          Copy-Item "dist_README.md" "dist\BexioDashboard\README.md"

          # Copier dans le dossier installer
          Copy-Item "dist_README.md" "dist\installer\README.md"

          # Cr√©er un fichier d'information sur le certificat
          $certInfo = @"
üîê INFORMATION CERTIFICAT AUTO-SIGN√â
====================================

Ce logiciel est sign√© avec un certificat AUTO-SIGN√â g√©n√©r√© automatiquement.

Signataire : CN=BSCO Solutions, O=BSCO Solutions, L=Geneva, S=Geneva, C=CH
Validit√©   : 3 ans

‚ö†Ô∏è Windows affichera "Unknown Publisher" - C'EST NORMAL !

Pour √©liminer ce message, un certificat EV professionnel (~500 EUR/an) serait n√©cessaire.

üìñ Lisez README.md pour plus d'informations sur l'installation.

‚úÖ Ce logiciel est 100% s√©curis√© et open-source :
   https://github.com/csigno1204/BSCO-Dashboard-PowerBI
"@

          $certInfo | Out-File -FilePath "dist\BexioDashboard\CERTIFICAT_INFO.txt" -Encoding UTF8
          $certInfo | Out-File -FilePath "dist\installer\CERTIFICAT_INFO.txt" -Encoding UTF8

          Write-Host "‚úÖ README et informations cr√©√©s" -ForegroundColor Green

      - name: üì§ Upload executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: BexioDashboard-Portable
          path: dist/BexioDashboard/
          retention-days: 30

      - name: üì§ Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: BexioDashboard-Installer
          path: dist/installer/*.exe
          retention-days: 90

      - name: üéâ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/installer/*.exe
          body: |
            ## üöÄ Dashboard Bexio ‚Üí Power BI - ${{ github.ref_name }}

            ### ‚ö†Ô∏è IMPORTANT - Message "Unknown Publisher"

            **Lors de l'installation, Windows affichera "√âditeur inconnu (Unknown Publisher)" - C'EST NORMAL !**

            Ce logiciel est sign√© avec un **certificat auto-sign√©** (gratuit) au lieu d'un certificat EV professionnel (~500 EUR/an).

            ‚úÖ **Le logiciel est 100% s√©curis√© et open-source**
            ‚úÖ **Vous pouvez v√©rifier la signature num√©rique** : CN=BSCO Solutions
            ‚úÖ **Code source disponible** : [GitHub Repository](https://github.com/${{ github.repository }})

            **Pour installer :**
            1. T√©l√©chargez `BexioDashboard_Setup_v*.exe`
            2. Double-cliquez
            3. Windows UAC ‚Üí "Unknown Publisher" ‚Üí **Cliquez "Oui"**
            4. Suivez l'assistant d'installation
            5. L'application installe automatiquement son certificat au premier lancement

            üìñ **Lisez le fichier README.md inclus dans le t√©l√©chargement pour plus de d√©tails**

            ---

            ### üì• Installation Rapide

            **M√©thode 1 : Installeur (Recommand√©)**
            - T√©l√©chargez `BexioDashboard_Setup_v*.exe`
            - Installation compl√®te avec raccourcis, d√©sinstallation propre

            **M√©thode 2 : Portable**
            - T√©l√©chargez l'artifact `BexioDashboard-Portable`
            - Extrayez et lancez `BexioDashboard.exe`
            - Aucune installation requise, fonctionne depuis cl√© USB

            ### ‚ú® Nouveaut√©s

            Voir [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ### üìö Documentation

            - **[README d'installation](https://github.com/${{ github.repository }}/blob/main/dist_README.md)** - ‚≠ê LISEZ-MOI EN PREMIER
            - [Guide d'installation](https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION.md)
            - [Guide d'utilisation](https://github.com/${{ github.repository }}/blob/main/docs/USAGE.md)
            - [Validation des donn√©es](https://github.com/${{ github.repository }}/blob/main/docs/VALIDATION_DONNEES.md)
            - [Troubleshooting](https://github.com/${{ github.repository }}/blob/main/docs/TROUBLESHOOTING.md)

            ### üíæ Fichiers

            - **BexioDashboard_Setup_v*.exe** : Installeur Windows complet (~100 MB)
              - ‚úÖ Sign√© num√©riquement (certificat auto-sign√©)
              - ‚úÖ Auto-installation du certificat
              - ‚úÖ Python et toutes d√©pendances incluses
              - ‚úÖ Installation en 1 clic (apr√®s acceptation UAC)

            ### üîê S√©curit√©

            **V√©rifier la signature :**
            ```powershell
            Get-AuthenticodeSignature "BexioDashboard_Setup_v*.exe" | Format-List *
            ```

            **R√©sultat attendu :**
            - Signer: CN=BSCO Solutions, O=BSCO Solutions, L=Geneva, S=Geneva, C=CH
            - Status: Valid (apr√®s installation du certificat)

            ### üêõ Probl√®mes ?

            - **Antivirus bloque ?** ‚Üí Faux positif PyInstaller classique. Ajoutez une exception.
            - **Windows SmartScreen ?** ‚Üí Cliquez "Plus d'infos" ‚Üí "Ex√©cuter quand m√™me"
            - **Autre probl√®me ?** ‚Üí Ouvrez une [issue](https://github.com/${{ github.repository }}/issues)

            ### üí° Pour √âliminer "Unknown Publisher"

            Pour une distribution professionnelle avec "√âditeur v√©rifi√© : BSCO Solutions" :
            - Certificat EV requis (~500 EUR/an)
            - Voir [CODE_SIGNING_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/docs/CODE_SIGNING_GUIDE.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Build Summary
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "   ‚úÖ BUILD COMPLET R√âUSSI!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üì¶ Artifacts cr√©√©s:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ Application portable: dist\BexioDashboard\" -ForegroundColor White
          Write-Host "  ‚úÖ Installeur sign√©: dist\installer\*.exe" -ForegroundColor White
          Write-Host ""
          Write-Host "üîê S√©curit√©:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ Certificat auto-sign√© g√©n√©r√©" -ForegroundColor White
          Write-Host "  ‚úÖ Application sign√©e num√©riquement" -ForegroundColor White
          Write-Host "  ‚úÖ Installeur sign√© num√©riquement" -ForegroundColor White
          Write-Host "  ‚úÖ Certificat inclus dans l'exe (auto-installation)" -ForegroundColor White
          Write-Host ""
          Write-Host "‚ö†Ô∏è  IMPORTANT:" -ForegroundColor Yellow
          Write-Host "  Windows affichera 'Unknown Publisher' - C'EST NORMAL" -ForegroundColor Yellow
          Write-Host "  Le certificat est auto-sign√© (gratuit), pas EV (~500 EUR/an)" -ForegroundColor Yellow
          Write-Host "  Les utilisateurs doivent cliquer 'Oui' dans l'UAC" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "üìñ Documentation incluse:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ README.md - Instructions compl√®tes d'installation" -ForegroundColor White
          Write-Host "  ‚úÖ CERTIFICAT_INFO.txt - Informations sur le certificat" -ForegroundColor White
          Write-Host ""

          if ("${{ github.ref }}" -like "refs/tags/*") {
            Write-Host "üéâ Release GitHub cr√©√©e automatiquement!" -ForegroundColor Green
            Write-Host "   Visitez: https://github.com/${{ github.repository }}/releases"
            Write-Host ""
            Write-Host "üí° Les utilisateurs verront l'avertissement 'Unknown Publisher' dans la release" -ForegroundColor Yellow
          } else {
            Write-Host "üí° Pour cr√©er une release:" -ForegroundColor Yellow
            Write-Host "   git tag v1.0.0"
            Write-Host "   git push origin v1.0.0"
          }
          Write-Host ""
          Write-Host "üöÄ L'exe est maintenant 100% portable et auto-installe son certificat!" -ForegroundColor Green
          Write-Host ""
