name: üîê Build Windows Installer (Signed)

# ‚ö†Ô∏è CE WORKFLOW EST D√âSACTIV√â PAR D√âFAUT ‚ö†Ô∏è
# Pour l'activer :
# 1. Obtenez un certificat de signature de code (DigiCert, Sectigo, etc.)
# 2. Ajoutez les secrets GitHub : CODESIGN_CERTIFICATE, CODESIGN_PASSWORD
# 3. Renommez ce fichier en .yml (retirez .DISABLED)

on:
  push:
    tags:
      - 'v*-signed'  # D√©clench√© sur les tags v1.0.0-signed, v1.1.0-signed, etc.
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  build-windows-installer-signed:
    name: Build Signed .exe Installer
    runs-on: windows-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: üî® Build executable with PyInstaller
        run: |
          pyinstaller --clean installer/BexioDashboard.spec

      - name: üìÇ List dist directory
        run: |
          dir dist\BexioDashboard
          echo "Executable created successfully!"

      - name: üîê Decode and import code signing certificate
        run: |
          # D√©coder le certificat depuis base64 (stock√© dans GitHub Secrets)
          $cert_bytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_CERTIFICATE }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\certificate.pfx", $cert_bytes)

          # Importer le certificat dans le store Windows
          $password = ConvertTo-SecureString "${{ secrets.CODESIGN_PASSWORD }}" -AsPlainText -Force
          Import-PfxCertificate -FilePath "${{ github.workspace }}\certificate.pfx" -CertStoreLocation Cert:\CurrentUser\My -Password $password

          Write-Host "‚úÖ Certificate imported successfully"

      - name: üîè Sign executable with SignTool
        run: |
          # Chemin vers SignTool (inclus dans Windows SDK)
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

          # Signer l'ex√©cutable principal
          & $signtool sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /a "dist\BexioDashboard\BexioDashboard.exe"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Executable signed successfully"
          } else {
            Write-Error "‚ùå Signing failed"
            exit 1
          }

      - name: üß™ Verify signature
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          & $signtool verify /pa /v "dist\BexioDashboard\BexioDashboard.exe"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Signature verified successfully"
          } else {
            Write-Error "‚ùå Signature verification failed"
            exit 1
          }

      - name: üì• Install Inno Setup via Chocolatey
        run: |
          choco install innosetup -y

          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "‚úÖ Inno Setup installed successfully"
          } else {
            Write-Error "‚ùå Inno Setup installation failed"
            exit 1
          }

      - name: üèóÔ∏è Build installer with Inno Setup
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"

          if (Test-Path $iscc) {
            & $iscc "installer\BexioDashboard_Setup.iss"
          } else {
            Write-Error "‚ùå Inno Setup Compiler not found at $iscc"
            exit 1
          }

      - name: üîè Sign installer with SignTool
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

          # Signer l'installeur
          & $signtool sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /a "dist\installer\BexioDashboard_Setup_*.exe"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Installer signed successfully"
          } else {
            Write-Error "‚ùå Installer signing failed"
            exit 1
          }

      - name: üß™ Verify installer signature
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          $installer = Get-Item "dist\installer\BexioDashboard_Setup_*.exe"

          & $signtool verify /pa /v $installer.FullName

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Installer signature verified successfully"
          } else {
            Write-Error "‚ùå Installer signature verification failed"
            exit 1
          }

      - name: üßπ Cleanup certificate
        if: always()
        run: |
          # Supprimer le fichier certificat
          if (Test-Path "${{ github.workspace }}\certificate.pfx") {
            Remove-Item "${{ github.workspace }}\certificate.pfx" -Force
          }

          # Supprimer du store Windows
          Get-ChildItem Cert:\CurrentUser\My | Where-Object { $_.Subject -like "*BSCO*" } | Remove-Item

      - name: üì¶ Verify installer created
        run: |
          if (Test-Path "dist\installer\BexioDashboard_Setup_*.exe") {
            $installer = Get-Item "dist\installer\BexioDashboard_Setup_*.exe"
            Write-Host "‚úÖ Signed installer created: $($installer.Name)"
            $size = $installer.Length / 1MB
            Write-Host "üìä Size: $([math]::Round($size, 2)) MB"

            # V√©rifier la signature
            $signature = Get-AuthenticodeSignature $installer.FullName
            Write-Host "üîè Signer: $($signature.SignerCertificate.Subject)"
            Write-Host "üîè Status: $($signature.Status)"
          } else {
            Write-Error "‚ùå Installer not found"
            exit 1
          }

      - name: üì§ Upload signed installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: BexioDashboard-Installer-Signed
          path: dist/installer/*.exe
          retention-days: 90

      - name: üéâ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/installer/*.exe
          body: |
            ## üîê Dashboard Bexio ‚Üí Power BI - ${{ github.ref_name }} (SIGNED)

            ### ‚úÖ Version Sign√©e Num√©riquement

            Cette version est **sign√©e num√©riquement** avec un certificat de confiance.

            **Avantages :**
            - ‚úÖ Aucun faux positif antivirus
            - ‚úÖ "√âditeur v√©rifi√© : BSCO Solutions" affich√© dans Windows
            - ‚úÖ Installation sans avertissement SmartScreen

            ### üì• Installation

            T√©l√©chargez `BexioDashboard_Setup_v*.exe` et double-cliquez pour installer.

            **Aucune exclusion antivirus n√©cessaire !**

            ### ‚ú® Nouveaut√©s

            Voir [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ### üìö Documentation

            - [Guide d'installation](https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION_UTILISATEUR.md)
            - [Guide d'utilisation](https://github.com/${{ github.repository }}/blob/main/docs/USAGE.md)

            ### üíæ Fichiers

            - **BexioDashboard_Setup_v*.exe** : Installeur Windows sign√© (~50-100 MB)
            - Signature num√©rique valide
            - Aucune d√©pendance requise (Python inclus)
            - Installation en 1 clic

            ### üîê V√©rification de Signature

            Vous pouvez v√©rifier la signature :
            1. Clic droit sur l'exe ‚Üí Propri√©t√©s
            2. Onglet "Signatures num√©riques"
            3. V√©rifiez : "Nom du signataire : BSCO Solutions"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Build Summary
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "   ‚úÖ SIGNED BUILD SUCCESSFUL!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üîê Signed artifacts cr√©√©s:" -ForegroundColor Cyan
          Write-Host "  - Signed application: dist\BexioDashboard\BexioDashboard.exe"
          Write-Host "  - Signed installer: dist\installer\*.exe"
          Write-Host ""

          if ("${{ github.ref }}" -like "refs/tags/*") {
            Write-Host "üéâ Signed Release GitHub cr√©√©e automatiquement!" -ForegroundColor Green
            Write-Host "   Visitez: https://github.com/${{ github.repository }}/releases"
          }
          Write-Host ""
